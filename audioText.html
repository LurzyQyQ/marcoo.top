<!-- <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #upload {
            position: fixed;
            top: 0;
            left: 0;
        }

        audio {
            position: fixed;
            top: 0;
            right: 0;
        }
    </style>
</head>

<body>
    <input type="file" id="upload" accept="audio/mpeg">
    <script>
        const upload = document.querySelector('#upload')

        upload.addEventListener('change', (e) => {
            const [file] = e.target.files
            if (!file) upload.value = ''
            const {
                type
            } = file
            if (!type.includes('audio')) {
                alert('仅支持音频格式文件')
                upload.value = ''
                return false
            }
            const url = URL.createObjectURL(file)
            draw(url)
        })

        function draw(url) {
            const {
                clientWidth: width,
                clientHeight: height,
            } = document.body
            const audio = new Audio
            audio.src = url
            audio.controls = true
            audio.load()
            const canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            document.body.appendChild(audio)
            document.body.appendChild(canvas)
            const canvasCtx = canvas.getContext('2d')
            const audioCtx = new AudioContext
            const sourceNode = audioCtx.createMediaElementSource(audio)
            // 音频分析器
            const analyser = audioCtx.createAnalyser()
            analyser.fftSize = 128 // FFT
            sourceNode.connect(analyser)
            analyser.connect(audioCtx.destination)
            const len = analyser.frequencyBinCount
            const buffer = new Uint8Array(len)
            const gap = 40 // 间隙
            const pillarWidth = (width / len) - gap
            const gradient = canvasCtx.createLinearGradient(0, 0, 0, 5)
            gradient.addColorStop(.5, 'skyblue')
            gradient.addColorStop(.5, 'skyblue')
            gradient.addColorStop(.5, 'skyblue')

            const render = () => {
                canvasCtx.fillStyle = '#fff'
                canvasCtx.fillRect(0, 0, width, height)
                analyser.getByteFrequencyData(buffer)
                let x = 0
                buffer.forEach(v => {
                    const pillarHeight = (v / 1600) * height
                    canvasCtx.fillStyle = gradient
                    canvasCtx.fillRect(x, height - (pillarHeight || 2), pillarWidth, pillarHeight || 2)
                    x += (pillarWidth + gap)
                })
                requestAnimationFrame(render)
            }
            render()
            audio.play()
        }
    </script>
</body>

</html> -->
